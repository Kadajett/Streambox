generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
}

// ============================================
// User Model
// ============================================

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  username     String   @unique
  passwordHash String   @map("password_hash")
  displayName  String?  @map("display_name")
  avatarUrl    String?  @map("avatar_url")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  channels      Channel[]
  comments      Comment[]
  videoLikes    VideoLike[]
  subscriptions Subscription[]

  @@map("users")
}

// ============================================
// Channel Model
// ============================================

model Channel {
  id          String   @id @default(cuid())
  name        String
  handle      String   @unique
  description String?
  bannerUrl   String?  @map("banner_url")
  avatarUrl   String?  @map("avatar_url")
  userId      String   @map("user_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  videos        Video[]
  subscribers   Subscription[]

  @@index([userId])
  @@map("channels")
}

// ============================================
// Video Model
// ============================================

enum VideoStatus {
  draft
  processing
  ready
  failed
}

enum VideoVisibility {
  public
  unlisted
  private
}

model Video {
  id           String          @id @default(cuid())
  title        String
  description  String?
  thumbnailUrl String?         @map("thumbnail_url")
  videoUrl     String?         @map("video_url")
  duration     Int?            // Duration in seconds
  status       VideoStatus     @default(draft)
  visibility   VideoVisibility @default(private)
  viewCount    Int             @default(0) @map("view_count")
  likeCount    Int             @default(0) @map("like_count")
  dislikeCount Int             @default(0) @map("dislike_count")
  channelId    String          @map("channel_id")
  createdAt    DateTime        @default(now()) @map("created_at")
  updatedAt    DateTime        @updatedAt @map("updated_at")
  publishedAt  DateTime?       @map("published_at")

  // Relations
  channel       Channel         @relation(fields: [channelId], references: [id], onDelete: Cascade)
  comments      Comment[]
  likes         VideoLike[]
  transcodeJobs TranscodeJob[]

  @@index([channelId])
  @@index([status, visibility])
  @@index([createdAt])
  @@map("videos")
}

// ============================================
// Comment Model
// ============================================

model Comment {
  id        String   @id @default(cuid())
  content   String
  userId    String   @map("user_id")
  videoId   String   @map("video_id")
  parentId  String?  @map("parent_id")
  likeCount Int      @default(0) @map("like_count")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user    User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  video   Video     @relation(fields: [videoId], references: [id], onDelete: Cascade)
  parent  Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies Comment[] @relation("CommentReplies")

  @@index([videoId])
  @@index([parentId])
  @@map("comments")
}

// ============================================
// VideoLike Model
// ============================================

enum LikeType {
  like
  dislike
}

model VideoLike {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  videoId   String   @map("video_id")
  type      LikeType
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  video Video @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@unique([userId, videoId])
  @@index([videoId])
  @@map("video_likes")
}

// ============================================
// Subscription Model
// ============================================

model Subscription {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  channelId String   @map("channel_id")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  channel Channel @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@unique([userId, channelId])
  @@index([channelId])
  @@map("subscriptions")
}

// ============================================
// TranscodeJob Model
// ============================================

enum TranscodeStatus {
  pending
  processing
  completed
  failed
}

model TranscodeJob {
  id        String          @id @default(cuid())
  videoId   String          @map("video_id")
  status    TranscodeStatus @default(pending)
  progress  Int             @default(0)
  error     String?
  createdAt DateTime        @default(now()) @map("created_at")
  updatedAt DateTime        @updatedAt @map("updated_at")

  // Relations
  video Video @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@index([videoId])
  @@index([status])
  @@map("transcode_jobs")
}
